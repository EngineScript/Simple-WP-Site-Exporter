<?xml version="1.0"?>
<ruleset name="Simple WP Site Exporter PHPCS Rules">
    <description>PHP_CodeSniffer configuration for Simple WP Site Exporter WordPress plugin</description>

    <!-- Include the WordPress coding standards -->
    <rule ref="WordPress">
        <!-- Exclude rules that are not applicable for plugins or cause false positives -->
        <exclude name="WordPress.Files.FileName.InvalidClassFileName"/>
        <exclude name="WordPress.Files.FileName.NotHyphenatedLowercase"/>
        
        <!-- Allow short array syntax [] instead of array() -->
        <exclude name="Generic.Arrays.DisallowShortArraySyntax"/>
        
        <!-- Allow superglobal access with proper sanitization -->
        <exclude name="WordPress.Security.ValidatedSanitizedInput.InputNotSanitized"/>
        
        <!-- Allow direct filesystem operations for controlled export operations -->
        <exclude name="WordPress.WP.AlternativeFunctions.file_system_read_readfile"/>
        <exclude name="WordPress.WP.AlternativeFunctions.file_get_contents_file_get_contents"/>
    </rule>

    <!-- Include WordPress Extra rules for enhanced security and best practices -->
    <rule ref="WordPress-Extra">
        <!-- Exclude overly strict filename rules for single-file plugins -->
        <exclude name="WordPress.Files.FileName"/>
        
        <!-- Allow inline comments for complex security validations -->
        <exclude name="Squiz.Commenting.InlineComment.InvalidEndChar"/>
    </rule>

    <!-- Include WordPress Docs rules for proper documentation -->
    <rule ref="WordPress-Docs"/>

    <!-- Include WordPress VIP rules for security and performance -->
    <rule ref="WordPressVIPMinimum">
        <!-- Allow necessary functions for export operations -->
        <exclude name="WordPressVIPMinimum.Functions.RestrictedFunctions.shell_exec_shell_exec"/>
        <exclude name="WordPressVIPMinimum.Functions.RestrictedFunctions.file_exists_file_exists"/>
        <exclude name="WordPressVIPMinimum.Functions.RestrictedFunctions.escapeshellarg_escapeshellarg"/>
        <exclude name="WordPressVIPMinimum.Files.IncludingFile.UsingVariable"/>
        
        <!-- Allow direct filesystem operations for export functionality -->
        <exclude name="WordPressVIPMinimum.Performance.FetchingRemoteData.FileGetContentsUnknown"/>
    </rule>

    <!-- Specify file extensions to check -->
    <arg name="extensions" value="php"/>

    <!-- Show progress and use colors -->
    <arg value="ps"/>

    <!-- Check all files in the plugin directory -->
    <file>.</file>

    <!-- Exclude certain directories and files -->
    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/tests/*</exclude-pattern>
    <exclude-pattern>*/build/*</exclude-pattern>
    <exclude-pattern>*/dist/*</exclude-pattern>
    <exclude-pattern>*/.git/*</exclude-pattern>

    <!-- Configure specific rules -->
    
    <!-- Set minimum PHP version for compatibility checks -->
    <config name="minimum_supported_wp_version" value="5.0"/>
    <config name="testVersion" value="7.4-"/>

    <!-- WordPress.NamingConventions.PrefixAllGlobals -->
    <rule ref="WordPress.NamingConventions.PrefixAllGlobals">
        <properties>
            <!-- Define the plugin prefix -->
            <property name="prefixes" type="array">
                <element value="sse"/>
                <element value="SSE"/>
                <element value="Simple_WP_Site_Exporter"/>
                <element value="ES_WP_SITE_EXPORTER"/>
            </property>
        </properties>
    </rule>

    <!-- WordPress.WP.I18n -->
    <rule ref="WordPress.WP.I18n">
        <properties>
            <!-- Define the text domain -->
            <property name="text_domain" type="array">
                <element value="Simple-WP-Site-Exporter"/>
            </property>
        </properties>
    </rule>

    <!-- Generic.Commenting.DocComment -->
    <rule ref="Generic.Commenting.DocComment">
        <!-- Allow @SuppressWarnings annotations for PHPMD -->
        <exclude name="Generic.Commenting.DocComment.TagValueIndent"/>
        <exclude name="Generic.Commenting.DocComment.NonParamGroup"/>
    </rule>

    <!-- Squiz.Commenting.FunctionComment -->
    <rule ref="Squiz.Commenting.FunctionComment">
        <!-- Allow missing parameter comments for simple functions -->
        <exclude name="Squiz.Commenting.FunctionComment.MissingParamTag"/>
        <exclude name="Squiz.Commenting.FunctionComment.ParamCommentFullStop"/>
        <exclude name="Squiz.Commenting.FunctionComment.ThrowsNotCapital"/>
    </rule>

    <!-- WordPress.Security.EscapeOutput -->
    <rule ref="WordPress.Security.EscapeOutput">
        <!-- Allow specific contexts where escaping is handled differently -->
        <properties>
            <property name="customAutoEscapedFunctions" type="array">
                <element value="wp_die"/>
                <element value="esc_html__"/>
                <element value="esc_attr__"/>
            </property>
        </properties>
    </rule>

    <!-- Generic.Files.LineLength -->
    <rule ref="Generic.Files.LineLength">
        <properties>
            <!-- Allow longer lines for complex security validations and URLs -->
            <property name="lineLimit" value="120"/>
            <property name="absoluteLineLimit" value="150"/>
        </properties>
        <!-- Exclude specific contexts where long lines are acceptable -->
        <exclude-pattern>*/phpcs.xml</exclude-pattern>
    </rule>

    <!-- WordPress.Arrays.MultipleStatementAlignment -->
    <rule ref="WordPress.Arrays.MultipleStatementAlignment">
        <properties>
            <!-- Allow flexible array alignment for better readability -->
            <property name="exact" value="false"/>
            <property name="maxColumn" value="1000"/>
        </properties>
    </rule>

    <!-- PSR2.Methods.FunctionCallSignature -->
    <rule ref="PSR2.Methods.FunctionCallSignature">
        <!-- Allow flexible function call formatting -->
        <exclude name="PSR2.Methods.FunctionCallSignature.SpaceAfterCloseBracket"/>
        <exclude name="PSR2.Methods.FunctionCallSignature.ContentAfterOpenBracket"/>
        <exclude name="PSR2.Methods.FunctionCallSignature.CloseBracketLine"/>
    </rule>

    <!-- WordPress.PHP.YodaConditions -->
    <!-- Note: Yoda conditions are required by WordPress standards -->
    <rule ref="WordPress.PHP.YodaConditions"/>

    <!-- Generic.Commenting.Fixme -->
    <rule ref="Generic.Commenting.Fixme">
        <!-- Treat TODO and FIXME as warnings instead of errors -->
        <type>warning</type>
    </rule>

    <!-- Squiz.PHP.CommentedOutCode -->
    <rule ref="Squiz.PHP.CommentedOutCode">
        <!-- Treat commented out code as warnings -->
        <type>warning</type>
    </rule>

    <!-- Custom exclusions for specific security contexts -->
    
    <!-- Allow direct superglobal access with proper sanitization -->
    <rule ref="WordPress.Security.ValidatedSanitizedInput.InputNotValidated">
        <!-- These are specifically validated and sanitized in our code -->
        <exclude-pattern>*simple-wp-site-exporter.php</exclude-pattern>
    </rule>

    <!-- Allow necessary shell operations for WP-CLI -->
    <rule ref="WordPress.PHP.DiscouragedPHPFunctions">
        <properties>
            <property name="exclude" type="array">
                <element value="shell_exec"/>
                <element value="escapeshellarg"/>
            </property>
        </properties>
    </rule>

    <!-- Allow direct file operations for controlled export operations -->
    <rule ref="WordPress.WP.AlternativeFunctions">
        <exclude-pattern>*simple-wp-site-exporter.php</exclude-pattern>
    </rule>

</ruleset>
